<!DOCTYPE html>
<html>
<head>
    <title>BasicRallyGrid</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.filterContainer=Ext.create("Ext.container.Container",{layout:{type:"hbox",align:"stretch"}}),this.add(this.filterContainer),this._loadReleaseSelection()},_loadReleaseSelection:function(){this.iterationCombo=Ext.create("Rally.ui.combobox.ReleaseComboBox",{width:300,fieldLabel:"PI Filter:",listeners:{ready:function(combobox){this._loadData()},select:function(combobox,records){this._loadData()},scope:this}}),this.filterContainer.add(this.iterationCombo)},_loadData:function(){this.iterations=[],this.userStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",autoLoad:!0,sorters:[{property:"Iteration",direction:"ASC"}],listeners:{load:function(userStoryStore,myData,success){this._sumData(userStoryStore,myData)},scope:this},fetch:["FormattedID","Owner","Name","ScheduleState","Iteration","PlanEstimate","AcceptedDate","Release"]})},_sumData:function(store,data){var totalPoints=0,acceptedPoints=0,iteration,selectedRelease=this.iterationCombo.getRecord().get("Name");Ext.Array.each(data,function(story){if(story.get("Iteration")){var it=story.get("Iteration"),result=this._matchIterationWithRelease(selectedRelease,it.Name);result&&(iteration?iteration&&(iteration==it.Name?(totalPoints+=story.get("PlanEstimate"),story.get("AcceptedDate")&&(acceptedPoints+=story.get("PlanEstimate"))):(summary={Iteration:iteration,PlanEstimate:totalPoints,AcceptedPoints:acceptedPoints,SDR:acceptedPoints/totalPoints},this.iterations.push(summary),totalPoints=0,acceptedPoints=0,iteration=it.Name,totalPoints+=story.get("PlanEstimate"),story.get("AcceptedDate")&&(acceptedPoints+=story.get("PlanEstimate")))):(iteration=it.Name,totalPoints+=story.get("PlanEstimate"),story.get("AcceptedDate")&&(acceptedPoints+=story.get("PlanEstimate"))))}},this),summary={Iteration:iteration,PlanEstimate:totalPoints,AcceptedPoints:acceptedPoints,SDR:acceptedPoints/totalPoints},this.iterations.push(summary),this._createCustomIterationStore()},_createCustomIterationStore:function(){this.iterationStore=Ext.create("Rally.data.custom.Store",{data:this.iterations,pageSize:100,listeners:{load:function(iterationStore,myData,success){this._loadGrid(iterationStore)},scope:this},scope:this})},_loadGrid:function(store){this.remove(this.myGrid),this.myGrid=Ext.create("Rally.ui.grid.Grid",{height:250,store:store,columnCfgs:[{text:"Iteration",dataIndex:"Iteration"},{text:"Estimate",dataIndex:"PlanEstimate"},{text:"Actual",dataIndex:"AcceptedPoints"},{text:"SDR",dataIndex:"SDR",renderer:function(value,m,r){var id=Ext.id();return Ext.defer(function(){Ext.create("Ext.Container",{items:[{xtype:"rallypercentdone",percentDone:value}],renderTo:id})},50),Ext.String.format('<div id="{0}"></div>',id)}}],scope:this,resizable:!0}),this.add(this.myGrid)},_matchIterationWithRelease:function(release,iteration){if(-1!=release.indexOf("EQ")){if(-1==iteration.indexOf("EQ"))return!1;if(-1!=release.indexOf("1"))return-1!=iteration.indexOf("1.")?!0:!1;if(-1!=release.indexOf("2"))return-1!=iteration.indexOf("2.")?!0:!1;if(-1!=release.indexOf("3"))return-1!=iteration.indexOf("3.")?!0:!1}else if(-1!=release.indexOf("OIS")){if(-1==iteration.indexOf("OIS"))return!1;if(-1!=release.indexOf("1"))return-1!=iteration.indexOf("1.")?!0:!1;if(-1!=release.indexOf("2"))return-1!=iteration.indexOf("2.")?!0:!1;if(-1!=release.indexOf("3"))return-1!=iteration.indexOf("3.")?!0:!1}else if(-1!=release.indexOf("KM")){if(-1==iteration.indexOf("KM"))return!1;if(-1!=release.indexOf("1"))return-1!=iteration.indexOf("1.")?!0:!1;if(-1!=release.indexOf("2"))return-1!=iteration.indexOf("2.")?!0:!1;if(-1!=release.indexOf("3"))return-1!=iteration.indexOf("3.")?!0:!1}return!1}});

            Rally.launchApp('CustomApp', {
                name:"BasicRallyGrid",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
